<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ page.title }} | Signals & Patterns</title>
  <meta name="description" content="{{ page.tldr }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/style.css" />

  <!-- SEO: Canonical & Indexing -->
  {% if page.canonical %}
    <link rel="canonical" href="{{ page.canonical }}">
  {% else %}
    <link rel="canonical" href="{{ site.url }}{{ page.url }}">
  {% endif %}

  {% if page.noindex == true %}
    <meta name="robots" content="noindex, nofollow">
  {% else %}
    <meta name="robots" content="index, follow">
  {% endif %}

  
  <!-- Utilities -->
  <script src="/assets/reading-time.js"></script>
  <script src="/assets/likes.js"></script>
</head>

<body>

  <!-- Section Progress (Dots) -->
  <div class="section-progress" id="sectionProgress"></div>

  <!-- ARTICLE HERO -->
  <section class="hero-banner">
    <img
      src="{{ page.banner }}"
      alt="{{ page.title }}"
      class="hero-bg"
    />
    <div class="hero-overlay">
      <h1>{{ page.title }}</h1>
    </div>
  </section>

  <!-- META -->
  <div class="article-meta">
    <span id="readingTime"></span>
    ·
    <button class="like-btn" data-slug="{{ page.url }}"></button>
  </div>

  <!-- ARTICLE CONTENT -->
  <article class="article">

    {% if page.tldr %}
      <section class="tldr">
        <strong>TL;DR</strong>
        <p>{{ page.tldr }}</p>
      </section>
    {% endif %}

    <section class="article-body">
      {{ content }}
    </section>

<section class="article-faqs" id="articleFaqs" hidden>
  <h2>Frequently Asked Questions</h2>
</section>

    
    <section class="article-footer">
      <a href="/blogs/" class="read-link">← Back to all articles</a>
    </section>

  </article>

  <!-- 1. AUTO-CREATE SECTION CARDS (FROM H2) -->
  <script>
  (function () {
    const body = document.querySelector('.article-body');
    if (!body) return;

    let currentCard = null;
    const children = Array.from(body.children);

    children.forEach(node => {
      if (node.tagName === 'H2') {
        currentCard = document.createElement('section');
        currentCard.className = 'article-card';
        node.before(currentCard);
      }
      if (currentCard) currentCard.appendChild(node);
    });
  })();
  </script>

  <!-- 2. REVEAL ANIMATION FOR CARDS -->
  <script>
  (function () {
    const cards = document.querySelectorAll('.article-card');
    if (!cards.length) return;

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
          }
        });
      },
      { threshold: 0.15 }
    );

    cards.forEach(card => observer.observe(card));
  })();
  </script>

  <!-- 3. SECTION PROGRESS DOTS -->
  <script>
  (function () {
    window.addEventListener('load', () => {
      const sections = document.querySelectorAll('.article-card');
      const progress = document.getElementById('sectionProgress');
      if (!sections.length || !progress) return;

      progress.innerHTML = '';

      sections.forEach(() => {
        const dot = document.createElement('div');
        dot.className = 'section-progress-dot';
        progress.appendChild(dot);
      });

      const dots = progress.querySelectorAll('.section-progress-dot');

      const observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const index = Array.from(sections).indexOf(entry.target);
              dots.forEach((dot, i) =>
                dot.classList.toggle('active', i <= index)
              );
            }
          });
        },
        { threshold: 0.4 }
      );

      sections.forEach(section => observer.observe(section));
    });
  })();
  </script>

  <!-- 4. KEY SENTENCE PULL-OUTS (SUBTLE) -->
  <script>
  (function () {
    const paragraphs = document.querySelectorAll('.article-body p');
    paragraphs.forEach(p => {
      const text = p.innerText.trim();
      if (
        text.length > 90 &&
        text.length < 220 &&
        !text.includes('?') &&
        !p.querySelector('a')
      ) {
        p.classList.add('key-sentence');
      }
    });
  })();
  </script>

  <!-- 5. READING TIME -->
  <script>
  (function () {
    const body = document.querySelector('.article-body');
    if (!body) return;

    const minutes = calculateReadingTime(body.innerText);
    document.getElementById('readingTime').innerText =
      `${minutes} min read`;
  })();
  </script>


<script>
(function () {
  const body = document.querySelector('.article-body');
  const faqContainer = document.getElementById('articleFaqs');
  if (!body || !faqContainer) return;

  const children = Array.from(body.children);

  // 1. Find FAQ start
  const faqStartIndex = children.findIndex(
    el => el.tagName === 'H2' && el.textContent.trim().toLowerCase() === 'faq'
  );

  if (faqStartIndex === -1) return;

  const faqs = [];
  let current = null;

  // 2. Parse FAQ block
  for (let i = faqStartIndex + 1; i < children.length; i++) {
    const el = children[i];

    if (el.tagName === 'H2') break; // FAQ section ends

    if (el.tagName === 'H3') {
      current = { question: el.textContent.trim(), answer: '' };
      faqs.push(current);
      continue;
    }

    if (current && el.tagName === 'P') {
      current.answer += el.textContent.trim() + ' ';
    }
  }

  if (!faqs.length) return;

  // 3. Hide original FAQ content
  for (let i = faqStartIndex; i < children.length; i++) {
    if (i === faqStartIndex || children[i].tagName !== 'H2') {
      children[i].style.display = 'none';
    } else {
      break;
    }
  }

  // 4. Render accordion
  faqContainer.hidden = false;

  faqs.forEach(faq => {
    const item = document.createElement('div');
    item.className = 'faq-item';

    item.innerHTML = `
      <button class="faq-question" aria-expanded="false">
        ${faq.question}
      </button>
      <div class="faq-answer">
        <p>${faq.answer.trim()}</p>
      </div>
    `;

    faqContainer.appendChild(item);
  });

  // 5. Accordion behavior
  faqContainer.addEventListener('click', e => {
    const btn = e.target.closest('.faq-question');
    if (!btn) return;

    const expanded = btn.getAttribute('aria-expanded') === 'true';
    faqContainer.querySelectorAll('.faq-question')
      .forEach(q => q.setAttribute('aria-expanded', 'false'));

    btn.setAttribute('aria-expanded', String(!expanded));
  });

  // 6. SEO: Inject FAQ schema
  const schema = {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map(f => ({
      "@type": "Question",
      "name": f.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": f.answer.trim()
      }
    }))
  };

  const schemaScript = document.createElement('script');
  schemaScript.type = 'application/ld+json';
  schemaScript.textContent = JSON.stringify(schema);
  document.head.appendChild(schemaScript);
})();
</script>
 

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ page.title | escape }}",
  "description": "{{ page.tldr | strip_html | escape }}",
  "image": "{{ site.url }}{{ page.banner }}",
  "datePublished": "{{ page.date | date_to_xmlschema }}",
  "dateModified": "{{ page.last_modified_at | default: page.date | date_to_xmlschema }}",
  "author": {
    "@type": "Person",
    "name": "{% if page.author %}{{ page.author.name }}{% else %}Signals & Patterns{% endif %}",
    "url": "{% if page.author %}{{ page.author.url }}{% else %}{{ site.url }}{% endif %}",
    "image": "{% if page.author %}{{ page.author.image }}{% endif %}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Signals & Patterns",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ site.url }}/assets/images/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{% if page.canonical %}{{ page.canonical }}{% else %}{{ site.url }}{{ page.url }}{% endif %}"
  }
}
</script>

<script>
(function () {
  const faqItems = document.querySelectorAll('.faq-item');
  if (!faqItems.length) return;

  const schema = {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": []
  };

  faqItems.forEach(item => {
    const question = item.querySelector('.faq-question')?.innerText.trim();
    const answer = item.querySelector('.faq-answer')?.innerText.trim();

    if (!question || !answer) return;

    schema.mainEntity.push({
      "@type": "Question",
      "name": question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": answer
      }
    });
  });

  if (!schema.mainEntity.length) return;

  const script = document.createElement('script');
  script.type = 'application/ld+json';
  script.textContent = JSON.stringify(schema);
  document.head.appendChild(script);
})();
</script>

  
</body>
</html>
