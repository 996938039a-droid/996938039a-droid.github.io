<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ page.title }} | Signals & Patterns</title>
  <meta name="description" content="{{ page.tldr }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/style.css" />

  {% if page.canonical %}
    <link rel="canonical" href="{{ page.canonical }}">
  {% else %}
    <link rel="canonical" href="{{ site.url }}{{ page.url }}">
  {% endif %}

  {% if page.noindex == true %}
    <meta name="robots" content="noindex, nofollow">
  {% else %}
    <meta name="robots" content="index, follow">
  {% endif %}

  <script src="/assets/reading-time.js"></script>
  <script src="/assets/likes.js"></script>
</head>

<body>

<!-- SECTION PROGRESS -->
<div class="section-progress" id="sectionProgress"></div>

<!-- HERO -->
<section class="hero-banner">
  <img src="{{ page.banner }}" alt="{{ page.title }}" class="hero-bg" />
  <div class="hero-overlay">
    <h1>{{ page.title }}</h1>
  </div>
</section>

<!-- META -->
<div class="article-meta">
  <span id="readingTime"></span>
  ·
  <button class="like-btn" data-slug="{{ page.url }}"></button>
</div>

<article class="article">

  {% if page.tldr %}
  <section class="tldr">
    <strong>TL;DR</strong>
    <p>{{ page.tldr }}</p>
  </section>
  {% endif %}

  <section class="article-body">
    {% if page.password_protected %}
    <div id="protectedContent" style="display:none">
      {{ content }}
    </div>
  {% else %}
    {{ content }}
  {% endif %}
  </section>

  <!-- FAQ TARGET -->
  <section id="articleFaqs"></section>

  <section class="article-footer">
    <a href="/blog/" class="read-link">← Back to all articles</a>
  </section>

</article>

<!-- ========================= -->
<!-- FAQ EXTRACTION (MUST RUN FIRST) -->
<!-- ========================= -->
<script>
(function () {
  const body = document.querySelector('.article-body');
  const faqMount = document.getElementById('articleFaqs');
  if (!body || !faqMount) return;

  const nodes = Array.from(body.children);
  const faqStart = nodes.findIndex(
    n => n.tagName === 'H2' && n.textContent.trim().toLowerCase() === 'faq'
  );
  if (faqStart === -1) return;

  const faqs = [];
  let i = faqStart + 1;

  while (i < nodes.length && nodes[i].tagName !== 'H2') {
    if (nodes[i].tagName === 'H3' && nodes[i + 1]?.tagName === 'P') {
      faqs.push({
        q: nodes[i].innerText.trim(),
        a: nodes[i + 1].innerText.trim()
      });
      i += 2;
    } else {
      i++;
    }
  }

  for (let j = faqStart; j < i; j++) nodes[j].remove();
  if (!faqs.length) return;

  faqMount.className = 'faq-container';
  faqMount.innerHTML = `
    <h2>FAQ</h2>
    ${faqs.map(f => `
      <div class="faq-item">
        <button class="faq-question" aria-expanded="false">${f.q}</button>
        <div class="faq-answer"><p>${f.a}</p></div>
      </div>
    `).join('')}
  `;

  faqMount.querySelectorAll('.faq-question').forEach(btn => {
    btn.addEventListener('click', () => {
      const open = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', !open);
      btn.nextElementSibling.style.maxHeight =
        open ? null : btn.nextElementSibling.scrollHeight + 'px';
    });
  });

  const schema = {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map(f => ({
      "@type": "Question",
      "name": f.q,
      "acceptedAnswer": { "@type": "Answer", "text": f.a }
    }))
  };

  const s = document.createElement('script');
  s.type = 'application/ld+json';
  s.textContent = JSON.stringify(schema);
  document.head.appendChild(s);
})();
</script>

<!-- ========================= -->
<!-- SECTION CARD CREATION -->
<!-- ========================= -->
<script>
(function () {
  const body = document.querySelector('.article-body');
  if (!body) return;

  let card = null;
  Array.from(body.children).forEach(node => {
    if (node.tagName === 'H2') {
      card = document.createElement('section');
      card.className = 'article-card';
      node.before(card);
    }
    if (card) card.appendChild(node);
  });
})();
</script>

<!-- CARD ANIMATIONS -->
<script>
(function () {
  const cards = document.querySelectorAll('.article-card');
  const io = new IntersectionObserver(
    entries => entries.forEach(e => e.isIntersecting && e.target.classList.add('is-visible')),
    { threshold: 0.15 }
  );
  cards.forEach(c => io.observe(c));
})();
</script>

<!-- PROGRESS DOTS -->
<script>
window.addEventListener('load', () => {
  const cards = document.querySelectorAll('.article-card');
  const progress = document.getElementById('sectionProgress');
  if (!cards.length || !progress) return;

  progress.innerHTML = '';
  cards.forEach(() => progress.appendChild(document.createElement('div')).className = 'section-progress-dot');
  const dots = progress.children;

  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const i = [...cards].indexOf(e.target);
        [...dots].forEach((d, j) => d.classList.toggle('active', j <= i));
      }
    });
  }, { threshold: 0.4 });

  cards.forEach(c => io.observe(c));
});
</script>

<!-- KEY SENTENCES -->
<script>
(function () {
  document.querySelectorAll('.article-body p').forEach(p => {
    const t = p.innerText.trim();
    if (t.length > 90 && t.length < 220 && !t.includes('?')) {
      p.classList.add('key-sentence');
    }
  });
})();
</script>

<!-- READING TIME -->
<script>
(function () {
  const body = document.querySelector('.article-body');
  if (!body) return;
  document.getElementById('readingTime').innerText =
    `${calculateReadingTime(body.innerText)} min read`;
})();
</script>

<!-- BLOG SCHEMA -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ page.title | escape }}",
  "description": "{{ page.tldr | strip_html | escape }}",
  "image": "{{ site.url }}{{ page.banner }}",
  "datePublished": "{{ page.date | date_to_xmlschema }}",
  "dateModified": "{{ page.last_modified_at | default: page.date | date_to_xmlschema }}",
  "publisher": {
    "@type": "Organization",
    "name": "Signals & Patterns",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ site.url }}/assets/images/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ site.url }}{{ page.url }}"
  }
}
</script>


{% if page.password_protected %}
<script>
(function () {
  const PASSWORD = "internaldoc"; // change per use
  const content = document.getElementById('protectedContent');
  if (!content) return;

  document.body.innerHTML = `
    <div style="
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0b0d10;
      color:#fff;
      text-align:center;
      padding:24px;
    ">
      <div>
        <h1>Protected Page</h1>
        <p>{{ page.password_hint }}</p>
        <input
          type="password"
          id="pw"
          placeholder="Enter password"
          style="padding:12px;font-size:16px;"
        />
        <br><br>
        <button onclick="unlock()">Unlock</button>
      </div>
    </div>
  `;

  window.unlock = function () {
    if (document.getElementById('pw').value === PASSWORD) {
      document.body.innerHTML = '';
      document.body.appendChild(content);
      content.style.display = 'block';
    } else {
      alert('Incorrect password');
    }
  };
})();
</script>
{% endif %}

</body>
</html>
